<!doctype html>
<html>
<head>
  <title>THE (MOVIE) CHART</title>
  <link href="https://fonts.googleapis.com/css?family=Lato:700,900" rel="stylesheet">

  <style type="text/css">
    body {
      font-size: 10px;
      font-family: 'Lato';
    }
    #mynetwork {
      width: 100%;
      height: 100vh;
      font-family: 'Lato';
      border: 1px solid lightgray;
      background-color:#FFFFFF;
    }
    .key-columns {
    	overflow: auto;
    }
    #key {
      width: 100%;
    }

    #key h3 { 
      font-size: 25px;
      margin-bottom: 0;
      padding-left: 10px;
    }

    #key p {
      float: left;
      display: inline-block;
      width: 16.667%;
      font-size: 14px;
      padding: 0 10px;
      box-sizing: border-box;
    }

    @media only screen and (max-width: 950px) {
    	#key p {
		  
		  width: 100%;
		}
	}
    p.blue { color: #008BFD;}
    p.red { color: #FF4E6F;}
    p.green { color: #1AD98D;}

    #eventSpan {
      width: 100%;
      height: 5vh;
      overflow: scroll;
    }

  </style>

  <script type="text/javascript" src="js/vis.min.js"></script>
  <script type="text/javascript" src="js/vis-network.min.js"></script>

  <link href="css/vis-network.min.css" rel="stylesheet" type="text/css" />

  <script type="text/javascript" src="js/categories.js"></script>
  <script type="text/javascript" src="js/movies.js"></script>
  <script type="text/javascript" src="js/secondary.js"></script>
  <script type="text/javascript" src="js/coords.js"></script>


  <script type="text/javascript"> 
    var DIR = 'img/';

    var nodes = null;
    var edges = null;
    var network = null;

    var changeChosenEdgeOpacity =
        function(values, id, selected, hovering) {
          values.opacity = 1;
        }

    var changeChosenNode =
      function(values, id, selected, hovering) {
        //values.color = rgba(1,1,1,.25);
        //values.size = 32;
        //values.shadowSize = 30;
      }

    
    var visCategories = categories.map(obj => {
          var mapped = {
          id: obj.id,
          label: obj.id,
          title: obj.title,
          group: 'category',
          x: obj.x,
          y: obj.y, 
          hover: {
            border: '#FFF',
          },
        }

       if (coordinates[obj.id] !== undefined) {
            mapped.x = coordinates[obj.id].x
            mapped.y = coordinates[obj.id].y
        }
        return mapped

    });

    //clean up the movie data and map the coords
    var visMoviedata = moviedata.map(obj =>{ 
           var newArray = {
            id: obj.movie,
            label: obj.movie,
            title: obj.title,
            image: DIR + obj.movie + '.jpg',
            color: obj.color,
            widthConstraint: {maximum: 170},
            chosen: { node: changeChosenNode  },
            font: {color:obj.color, strokeWidth:3, strokeColor:'#ffffff'}
           }

           if (coordinates[obj.movie] !== undefined) {
            newArray.x = coordinates[obj.movie].x
            newArray.y = coordinates[obj.movie].y
        }
           return newArray;
        });

    // create the lines for primary categories
     var primaryEdges = moviedata.map(movies => {
         return { 
          from: movies.movie, 
          to: movies.category,
          chosen: { edge: changeChosenEdgeOpacity  }
        };
      });

     // dashed line for secondary categories
    var secondaryEdges = secondaryCategories.map(obj =>{
      return {
        from: obj.movie,
        to: obj.category,
        dashes:true,
        width: 1, 
        chosen: { edge: changeChosenEdgeOpacity  },
        arrows: {
            to:   {enabled: true, scaleFactor:1, type:'arrow'}
          },

        color: {/*opacity: 0.5,*/ color: obj.category === 'So Bad It Made Me Mad' ? '#333' : undefined }
      }
    });

    
    // Called when the Visualization API is loaded.
    function draw() {
      nodes = visMoviedata.concat(visCategories);

      edges = primaryEdges.concat(secondaryEdges);
      /*edges = primaryEdges;*/

      // create a network
      var container = document.getElementById('mynetwork');

      var data = {
        nodes: nodes,
        edges: edges
      };

      // OPTIONS
      var options = {

        nodes: {
          shape: 'circularImage', 
          borderWidth: 5,
          size:30,
          font: {
            face: 'lato',
            background: '#FFF',
            size: 18
          },
          color: {
            highlight: {
              background: '#FFFFFF'
            }
          },
        
        },
        edges: {
          color: {opacity: 1},
          width: 5,
          smooth: { type: "discrete", roundness: .5}
        },

        groups: 
          {
            category: 
              {
                color: {
                  background:'#FFFFFF',
                  border:'black',
                }, 
                font: {
                  size:30,
                  strokeWidth: 1
                }, 
                shape:'box', 
                margin: 10, x: 0, y: 0,  
                borderWidth: 0
              }
          },

          layout:{randomSeed:2},
          interaction:{hover:true},

          physics:{
            enabled: false,
          }
      };

      network = new vis.Network(container, data, options);
      

      /*network.once("beforeDrawing", function() {
        network.focus(2, {
          scale: 2
        });
      });
           network.once("afterDrawing", function() {
          network.fit({
            animation: {
              duration: 100,
              easingFunction: "linear"
            }
          });
        });
    */

      
      network.on("dragEnd", function (params) {
          params.event = "[original event]";
          //document.getElementById('eventSpan').innerHTML =  JSON.stringify(params.pointer.canvas, null, 4);
      });

      let isHovering = false

      network.on("hoverNode", function (params) {
          var connected = network.getConnectedNodes(params.node);
          //console.log(connected);
         
          isHovering = true;

          network.setOptions({ edges: { color: { opacity: 0.2 } } });
      });

      //jesses code
      

      // when even happens, isHovering = true

      window.addEventListener('mousemove', event => {
        if (!isHovering) return
        const bounds = document.getElementById('mynetwork').getBoundingClientRect()
        const xOffset = bounds.left
        const yOffset = bounds.top
        const node = network.getNodeAt({ x: event.clientX - xOffset, y: event.clientY - yOffset })

        if (node === undefined) {
          isHovering = false;
          network.setOptions({ edges: { color: { opacity: 1 } } }); // Reset opaque
        }
      })

     
      // This function sets coordinates to be a map of nodeId to coordinates
      function updateCoordinates(params) {
        params.nodes.forEach(node => {
        coordinates[node] = { x: params.pointer.canvas.x, y: params.pointer.canvas.y } 
      })

      //document.getElementById('eventSpan').innerHTML = JSON.stringify(coordinates)
      }
      // After the above function runs copy the eventSpan content and replace the value of const coordinates with it

      network.on("dragEnd", updateCoordinates)

    }

  </script>
  
</head>

<body onload="draw()">


<div id="key">
  <h3> KEY </h3>
  <div class="key-columns">
  <p>Films have a solid line to their primary theme. They are connected to secondary and tertiary themes with a dashed line. 
  </p>
  <p>
    Movies directly linked to <b>"So Bad"</b> are not worth seeing but are worth knowing and complaining about. Movies with a dashed line to So Bad are worth watching, it just might not be fun.
  </p>

  <p class="blue">Blue Titles are of significant cultural/entertainment value. These movies are oft discussed. Usually but not necessarily an endorsement of quality.</p>
  <p class="green">Green Titles are less prominent but high quality and enjoyable. Typically a safe bet.</p>
  <p class="red">Red Titles are third tier but well worth watching.</p>
  <p>Note: Color classifications are determined how good a movie is and how iconic it is. Blue movies don't necessarily have both, and Red movies certainly don't lack both. The iconic factor is weighted more heavily than quality.</p>
</div>

</div>
<div id="mynetwork"></div>
<!-- <div id="eventSpan"></div>
 -->
</body>
</html>
